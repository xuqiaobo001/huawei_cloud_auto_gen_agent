<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>昇腾云业务 - 华为云编排系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="/static/css/layout.css" rel="stylesheet">
    <style>
        body { background: #f5f7fa; }
        .search-box { background: #fff; border-radius: 12px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
        .stat-card { background: #fff; border-radius: 10px; padding: 16px; box-shadow: 0 1px 4px rgba(0,0,0,0.05); text-align: center; }
        .stat-card .stat-num { font-size: 1.8rem; font-weight: 700; color: #0d6efd; }
        .stat-card .stat-label { font-size: 0.85rem; color: #6c757d; }
        .result-card { background: #fff; border-radius: 10px; padding: 18px; margin-bottom: 12px; box-shadow: 0 1px 4px rgba(0,0,0,0.05); cursor: pointer; transition: box-shadow 0.2s; }
        .result-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .result-card .title { font-weight: 600; font-size: 1.05rem; }
        .result-card .content-preview { color: #555; font-size: 0.9rem; max-height: 60px; overflow: hidden; transition: max-height 0.3s; }
        .result-card.expanded .content-preview { max-height: 2000px; }
        .similarity-badge { font-size: 0.78rem; }
        .category-tag { font-size: 0.8rem; cursor: pointer; }
        .example-btn { font-size: 0.85rem; }
        .cat-browse-tag { cursor: pointer; transition: background 0.2s; }
        .cat-browse-tag:hover { opacity: 0.85; }
        #loading { display: none; }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-brand">
            <i class="fas fa-cloud"></i>
            <span class="brand-text">华为云编排系统</span>
        </div>
        <ul class="sidebar-nav">
            <li class="sidebar-item"><a href="/"><i class="fas fa-home"></i><span class="nav-text">首页</span></a></li>
            <li class="sidebar-item"><a href="/auto"><i class="fas fa-robot"></i><span class="nav-text">AI自动生成</span></a></li>
            <li class="sidebar-item"><a href="/history"><i class="fas fa-history"></i><span class="nav-text">历史记录</span></a></li>
            <li class="sidebar-item"><a href="/designer"><i class="fas fa-project-diagram"></i><span class="nav-text">工作流设计器</span></a></li>
            <li class="sidebar-item"><a href="/monitor"><i class="fas fa-chart-line"></i><span class="nav-text">监控中心</span></a></li>
            <li class="sidebar-item"><a href="/services"><i class="fas fa-cogs"></i><span class="nav-text">服务管理</span></a></li>
            <li class="sidebar-item"><a href="/graph"><i class="fas fa-share-alt"></i><span class="nav-text">服务依赖图</span></a></li>
            <li class="sidebar-item active"><a href="/ascend"><i class="fas fa-microchip"></i><span class="nav-text">昇腾云业务</span></a></li>
            <li class="sidebar-item"><a href="/settings"><i class="fas fa-sliders-h"></i><span class="nav-text">设置</span></a></li>
        </ul>
        <div class="sidebar-toggle" onclick="toggleSidebar()">
            <i class="fas fa-chevron-left"></i>
        </div>
    </div>

    <!-- Topbar -->
    <div class="topbar" id="topbar">
        <button class="topbar-toggle" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
        <div class="ms-auto d-flex align-items-center gap-3">
            <span class="badge {{ 'bg-success' if llm_available else 'bg-warning text-dark' }}">
                <i class="fas fa-brain"></i> LLM: {{ '已启用' if llm_available else '未配置' }}
            </span>
            <span class="text-muted"><i class="fas fa-user-circle"></i> {{ username }}</span>
            <a class="text-muted text-decoration-none small" href="/logout"><i class="fas fa-sign-out-alt"></i> 登出</a>
        </div>
    </div>

    <div class="main-content" id="main-content">
    <div class="container">
        <!-- 搜索栏 -->
        <div class="search-box mb-4">
            <h5 class="mb-3"><i class="fas fa-microchip text-primary"></i> 昇腾云业务知识搜索</h5>
            <div class="row g-2 align-items-end">
                <div class="col-md-6">
                    <input type="text" id="searchInput" class="form-control" placeholder="输入关键词进行语义搜索，如：DeepSeek 部署、NPU 规格...">
                </div>
                <div class="col-md-3">
                    <select id="categoryFilter" class="form-select">
                        <option value="">全部分类</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-primary w-100" onclick="doSearch()"><i class="fas fa-search"></i> 搜索</button>
                </div>
                <div class="col-md-1">
                    <button class="btn btn-outline-secondary w-100" onclick="clearSearch()" title="清空"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <div class="mt-3">
                <span class="text-muted small me-2">快捷查询：</span>
                <button class="btn btn-outline-primary btn-sm example-btn me-1 mb-1" onclick="exampleSearch('如何部署 DeepSeek-R1')">如何部署 DeepSeek-R1</button>
                <button class="btn btn-outline-primary btn-sm example-btn me-1 mb-1" onclick="exampleSearch('NPU 资源池规格')">NPU 资源池规格</button>
                <button class="btn btn-outline-primary btn-sm example-btn me-1 mb-1" onclick="exampleSearch('性能测试工具')">性能测试工具</button>
                <button class="btn btn-outline-primary btn-sm example-btn me-1 mb-1" onclick="exampleSearch('ModelArts 推理服务')">ModelArts 推理服务</button>
                <button class="btn btn-outline-primary btn-sm example-btn me-1 mb-1" onclick="exampleSearch('昇腾集群配置')">昇腾集群配置</button>
            </div>
        </div>

        <div class="row">
            <!-- 左侧统计 -->
            <div class="col-md-3">
                <div class="stat-card mb-3">
                    <div class="stat-num" id="statTotal">-</div>
                    <div class="stat-label">总文档数</div>
                </div>
                <div class="stat-card mb-3">
                    <div class="stat-num" id="statCategories">-</div>
                    <div class="stat-label">分类数</div>
                </div>
                <div class="mb-3">
                    <h6 class="text-muted"><i class="fas fa-tags"></i> 分类浏览</h6>
                    <div id="categoryList"></div>
                </div>
            </div>

            <!-- 主区域：搜索结果 -->
            <div class="col-md-9">
                <div id="loading" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status"></div>
                    <div class="mt-2 text-muted">搜索中...</div>
                </div>
                <div id="resultsArea">
                    <div class="text-center text-muted py-5" id="emptyHint">
                        <i class="fas fa-search fa-3x mb-3 d-block"></i>
                        输入关键词或点击快捷查询开始搜索
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div><!-- /main-content -->

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/layout.js"></script>
    <script>
    const CATEGORY_COLORS = ['primary','success','danger','warning','info','secondary','dark'];

    document.addEventListener('DOMContentLoaded', loadStats);
    document.getElementById('searchInput').addEventListener('keydown', e => { if (e.key === 'Enter') doSearch(); });

    async function loadStats() {
        try {
            const res = await fetch('/api/ascend/stats');
            const json = await res.json();
            if (!json.success) return;
            const d = json.data;
            document.getElementById('statTotal').textContent = d.total_documents;
            document.getElementById('statCategories').textContent = d.total_categories;
            const sel = document.getElementById('categoryFilter');
            const listEl = document.getElementById('categoryList');
            let html = '';
            let idx = 0;
            for (const [cat, count] of Object.entries(d.documents_by_category || {})) {
                const color = CATEGORY_COLORS[idx % CATEGORY_COLORS.length];
                sel.innerHTML += `<option value="${cat}">${cat} (${count})</option>`;
                html += `<span class="badge bg-${color} cat-browse-tag me-1 mb-1 px-2 py-1" onclick="browseCategory('${cat}')">${cat} <small>(${count})</small></span>`;
                idx++;
            }
            listEl.innerHTML = html;
        } catch(e) { console.error('加载统计失败', e); }
    }

    async function doSearch() {
        const query = document.getElementById('searchInput').value.trim();
        if (!query) return;
        const cat = document.getElementById('categoryFilter').value;
        document.getElementById('loading').style.display = 'block';
        document.getElementById('emptyHint').style.display = 'none';
        try {
            const params = new URLSearchParams({query, n_results: 10});
            if (cat) params.append('category_filter', cat);
            const res = await fetch('/api/ascend/search?' + params);
            const json = await res.json();
            document.getElementById('loading').style.display = 'none';
            if (!json.success) { showError(json.error); return; }
            renderResults(json.data, query);
        } catch(e) {
            document.getElementById('loading').style.display = 'none';
            showError('搜索请求失败');
        }
    }

    function renderResults(results, label) {
        const area = document.getElementById('resultsArea');
        if (!results.length) {
            area.innerHTML = '<div class="text-center text-muted py-4"><i class="fas fa-inbox fa-2x mb-2 d-block"></i>未找到相关结果</div>';
            return;
        }
        let html = `<div class="mb-2 text-muted small">找到 ${results.length} 条相关结果${label ? '（' + label + '）' : ''}</div>`;
        results.forEach((r, i) => {
            const sim = r.similarity !== undefined ? (r.similarity * 100).toFixed(1) : null;
            const simBadge = sim !== null ? `<span class="badge bg-info similarity-badge">相似度 ${sim}%</span>` : '';
            const catColor = CATEGORY_COLORS[Object.keys(r).length % CATEGORY_COLORS.length];
            const tags = r.tags ? r.tags.split(',').filter(Boolean).map(t => `<span class="badge bg-light text-dark me-1">${t.trim()}</span>`).join('') : '';
            html += `<div class="result-card" onclick="this.classList.toggle('expanded')">
                <div class="d-flex justify-content-between align-items-start mb-1">
                    <span class="title">${r.title || '无标题'}</span>
                    <span>${simBadge}</span>
                </div>
                <div class="mb-2">
                    <span class="badge bg-primary category-tag me-1" onclick="event.stopPropagation();browseCategory('${r.category}')">${r.category}</span>
                    ${tags}
                </div>
                <div class="content-preview">${escapeHtml(r.document || '')}</div>
                <div class="text-muted small mt-1"><i class="fas fa-chevron-down"></i> 点击展开/收起</div>
            </div>`;
        });
        area.innerHTML = html;
    }

    async function browseCategory(cat) {
        document.getElementById('searchInput').value = '';
        document.getElementById('categoryFilter').value = cat;
        document.getElementById('loading').style.display = 'block';
        document.getElementById('emptyHint').style.display = 'none';
        try {
            const res = await fetch(`/api/ascend/category/${encodeURIComponent(cat)}`);
            const json = await res.json();
            document.getElementById('loading').style.display = 'none';
            if (!json.success) { showError(json.error); return; }
            renderResults(json.data, `分类：${cat}`);
        } catch(e) {
            document.getElementById('loading').style.display = 'none';
            showError('获取分类数据失败');
        }
    }

    function exampleSearch(q) {
        document.getElementById('searchInput').value = q;
        doSearch();
    }

    function clearSearch() {
        document.getElementById('searchInput').value = '';
        document.getElementById('categoryFilter').value = '';
        document.getElementById('resultsArea').innerHTML = '<div class="text-center text-muted py-5" id="emptyHint"><i class="fas fa-search fa-3x mb-3 d-block"></i>输入关键词或点击快捷查询开始搜索</div>';
    }

    function showError(msg) {
        document.getElementById('resultsArea').innerHTML = `<div class="alert alert-danger">${msg}</div>`;
    }

    function escapeHtml(text) {
        const d = document.createElement('div');
        d.textContent = text;
        return d.innerHTML.replace(/\n/g, '<br>');
    }
    </script>
</body>
</html>