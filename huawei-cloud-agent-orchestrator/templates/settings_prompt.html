<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <title>Prompt模板配置 - 华为云Agent编排系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="/static/css/style.css" rel="stylesheet">
    <style>
        /* ===== System Prompt Display ===== */
        .sp-container {
            border: none;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 12px rgba(0,0,0,.06);
        }
        .sp-container .card-header {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            padding: 14px 20px;
            border: none;
        }
        .sp-container .card-header .btn { border-color: rgba(255,255,255,.3); color: #fff; }
        .sp-container .card-header .btn:hover { background: rgba(255,255,255,.15); }
        .sp-rendered { padding: 0; }
        .sp-rendered .sp-section {
            padding: 16px 20px;
            border-bottom: 1px solid #f0f0f0;
        }
        .sp-rendered .sp-section:last-child { border-bottom: none; }
        .sp-rendered .sp-section-title {
            font-size: 0.78rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #0d6efd;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .sp-rendered .sp-role-text {
            font-size: 0.9rem;
            line-height: 1.7;
            color: #333;
        }
        .sp-rendered .sp-json-block {
            background: #1e1e2e;
            color: #cdd6f4;
            border-radius: 8px;
            padding: 14px 16px;
            font-size: 0.8rem;
            font-family: 'Fira Code', 'Cascadia Code', monospace;
            overflow-x: auto;
            max-height: 260px;
            overflow-y: auto;
            line-height: 1.5;
        }
        .sp-rendered .sp-json-block .jk { color: #89b4fa; }
        .sp-rendered .sp-json-block .js { color: #a6e3a1; }
        .sp-rendered .sp-json-block .jn { color: #fab387; }
        .sp-rendered .sp-json-block .jp { color: #cba6f7; }
        .sp-rendered .sp-rule-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .sp-rendered .sp-rule-list li {
            padding: 6px 0 6px 24px;
            position: relative;
            font-size: 0.85rem;
            color: #444;
            line-height: 1.5;
        }
        .sp-rendered .sp-rule-list li::before {
            content: '';
            position: absolute;
            left: 6px;
            top: 13px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #0d6efd;
        }
        .sp-rendered .sp-var-tag {
            display: inline-block;
            background: #e8f0fe;
            color: #1a73e8;
            font-family: monospace;
            font-size: 0.78rem;
            padding: 1px 6px;
            border-radius: 4px;
        }
        .sp-collapse-toggle {
            cursor: pointer;
            user-select: none;
        }
        .sp-collapse-toggle::after {
            content: '\f078';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            font-size: 0.65rem;
            margin-left: 6px;
            transition: transform .2s;
            display: inline-block;
        }
        .sp-collapse-toggle.collapsed::after { transform: rotate(-90deg); }

        /* ===== Exhibition Card Styles ===== */
        .example-card {
            transition: transform .2s ease, box-shadow .2s ease;
            cursor: default;
            border: none;
            border-left: 4px solid #0d6efd;
            border-radius: 8px;
            overflow: hidden;
        }
        .example-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0,0,0,.12) !important;
        }
        .example-card .card-header-strip {
            height: 4px;
            background: linear-gradient(90deg, #0d6efd, #6610f2, #0dcaf0);
        }
        .example-card .card-body { padding: 1.25rem; }
        .example-card .card-title {
            font-size: 1rem;
            font-weight: 600;
            color: #1a1a2e;
        }
        .example-card .card-desc {
            font-size: 0.85rem;
            color: #6c757d;
            line-height: 1.5;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .example-card .svc-badge {
            font-size: 0.72rem;
            padding: 3px 8px;
            border-radius: 12px;
            font-weight: 500;
        }
        .example-card .card-footer-bar {
            background: #f8f9fa;
            padding: 0.6rem 1.25rem;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .example-card .task-count {
            font-size: 0.8rem;
            color: #495057;
        }
        .example-card .user-req-preview {
            font-size: 0.78rem;
            color: #888;
            background: #f0f4ff;
            border-radius: 6px;
            padding: 6px 10px;
            margin-top: 8px;
            border-left: 3px solid #0d6efd;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* View mode: list */
        .view-list .col-card { flex: 0 0 100%; max-width: 100%; }
        .view-list .example-card { flex-direction: row; }
        .view-list .example-card .card-body { display: flex; gap: 1.5rem; align-items: flex-start; flex-wrap: wrap; }
        .view-list .card-desc { -webkit-line-clamp: 1; }
        .view-list .user-req-preview { -webkit-line-clamp: 1; }

        /* Search & toolbar */
        .search-toolbar {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 12px 16px;
            margin-bottom: 16px;
        }
        .search-toolbar .form-control:focus,
        .search-toolbar .form-select:focus {
            box-shadow: 0 0 0 2px rgba(13,110,253,.15);
        }
        .view-toggle-btn {
            border: 1px solid #dee2e6;
            background: #fff;
            color: #6c757d;
            width: 36px; height: 36px;
            display: inline-flex; align-items: center; justify-content: center;
            border-radius: 6px;
            cursor: pointer;
            transition: all .15s;
        }
        .view-toggle-btn:hover, .view-toggle-btn.active {
            background: #0d6efd;
            color: #fff;
            border-color: #0d6efd;
        }

        /* Pagination enhanced */
        .pagination-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 16px;
            padding: 10px 0;
        }
        .pagination-bar .page-info {
            font-size: 0.85rem;
            color: #6c757d;
        }
        .pagination .page-link {
            border-radius: 6px;
            margin: 0 2px;
            font-size: 0.875rem;
        }

        /* Fade-in animation */
        @keyframes cardFadeIn {
            from { opacity: 0; transform: translateY(12px); }
            to   { opacity: 1; transform: translateY(0); }
        }
        .card-animate { animation: cardFadeIn .3s ease forwards; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-cloud"></i>
                华为云编排系统
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item"><a class="nav-link" href="/" id="nav-home"><i class="fas fa-home"></i> 首页</a></li>
                    <li class="nav-item"><a class="nav-link" href="/auto" id="nav-auto"><i class="fas fa-robot"></i> AI自动生成</a></li>
                    <li class="nav-item"><a class="nav-link" href="/history" id="nav-history"><i class="fas fa-history"></i> 历史记录</a></li>
                    <li class="nav-item"><a class="nav-link" href="/designer" id="nav-designer"><i class="fas fa-project-diagram"></i> 工作流设计器</a></li>
                    <li class="nav-item"><a class="nav-link" href="/monitor" id="nav-monitor"><i class="fas fa-chart-line"></i> 监控中心</a></li>
                    <li class="nav-item"><a class="nav-link" href="/services" id="nav-services"><i class="fas fa-cogs"></i> 服务管理</a></li>
                    <li class="nav-item"><a class="nav-link" href="/graph" id="nav-graph"><i class="fas fa-share-alt"></i> 服务依赖图</a></li>
                    <li class="nav-item"><a class="nav-link" href="/ascend" id="nav-ascend"><i class="fas fa-microchip"></i> 昇腾云业务</a></li>
                    <li class="nav-item"><a class="nav-link active" href="/settings" id="nav-settings"><i class="fas fa-sliders-h"></i> 设置</a></li>
                </ul>
                <ul class="navbar-nav align-items-center">
                    <li class="nav-item">
                        <span class="badge {{ 'bg-success' if llm_available else 'bg-warning text-dark' }}">
                            <i class="fas fa-brain"></i> LLM: {{ '已启用' if llm_available else '未配置' }}
                        </span>
                    </li>
                    <li class="nav-item ms-3 border-start border-light ps-3">
                        <span class="navbar-text text-white"><i class="fas fa-user-circle"></i> {{ username }}</span>
                        <a class="text-white-50 ms-2 text-decoration-none small" href="/logout"><i class="fas fa-sign-out-alt"></i> 登出</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <main class="container mt-4">
        <!-- 面包屑 -->
        <nav aria-label="breadcrumb" class="mb-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/settings">设置</a></li>
                <li class="breadcrumb-item active">Prompt 模板配置</li>
            </ol>
        </nav>

        <div>
                <!-- ===== System Prompt ===== -->
                <h4 class="mb-4"><i class="fas fa-file-alt"></i> System Prompt</h4>

                <div class="card mb-5 sp-container">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span class="fw-bold"><i class="fas fa-robot me-2"></i>System Prompt 模板</span>
                        <div>
                            <button class="btn btn-sm btn-outline-light" id="toggleRawBtn" title="切换原始/渲染视图">
                                <i class="fas fa-code"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-light ms-1" id="editSystemPromptBtn">
                                <i class="fas fa-edit"></i> 编辑
                            </button>
                            <button class="btn btn-sm btn-outline-light ms-1" id="previewPromptBtn">
                                <i class="fas fa-eye"></i> 预览完整Prompt
                            </button>
                        </div>
                    </div>
                    <div class="card-body sp-rendered" id="systemPromptRendered">
                        <!-- JS will render structured view here -->
                    </div>
                    <div class="card-body" id="systemPromptRawWrap" style="display:none;">
                        <pre id="systemPromptView" class="bg-light p-3 rounded" style="white-space:pre-wrap; max-height:400px; overflow-y:auto; font-size:13px;">{{ agent_config.get('system_prompt', '') if agent_config else '' }}</pre>
                    </div>
                    <div class="card-body" id="systemPromptEditWrap" style="display:none;">
                        <textarea id="systemPromptEditor" class="form-control" rows="14" style="font-size:13px; font-family:monospace;"></textarea>
                        <div class="mt-2 d-flex gap-2">
                            <button class="btn btn-sm btn-primary" id="saveSystemPromptBtn">
                                <i class="fas fa-save"></i> 保存
                            </button>
                            <button class="btn btn-sm btn-secondary" id="cancelSystemPromptBtn">取消</button>
                        </div>
                    </div>
                </div>

        </div>

        <!-- ===== 示例工作流 (全宽) ===== -->
        <div class="mt-2 mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <h4 class="mb-0"><i class="fas fa-book"></i> 示例工作流 (Few-shot Examples)</h4>
                    <p class="text-muted small mb-0 mt-1">作为 Few-shot 提示注入 User Prompt，帮助 LLM 理解期望的输出格式和资源编排模式。</p>
                </div>
                <button class="btn btn-sm btn-outline-primary" id="editExamplesBtn">
                    <i class="fas fa-edit"></i> 编辑JSON
                </button>
            </div>

            <!-- 搜索工具栏 -->
            <div class="search-toolbar" id="searchToolbar">
                <div class="d-flex gap-2 align-items-center flex-wrap">
                    <div class="input-group" style="max-width:320px;">
                        <span class="input-group-text bg-white"><i class="fas fa-search text-muted"></i></span>
                        <input type="text" id="exampleSearch" class="form-control" placeholder="搜索名称、描述、需求...">
                        <button class="btn btn-outline-secondary d-none" id="clearSearchBtn" type="button"><i class="fas fa-times"></i></button>
                    </div>
                    <select class="form-select form-select-sm" id="serviceFilter" style="max-width:160px;">
                        <option value="">全部服务</option>
                    </select>
                    <div class="ms-auto d-flex align-items-center gap-2">
                        <span class="text-muted small" id="exampleStats"></span>
                        <div class="d-flex gap-1">
                            <button class="view-toggle-btn active" id="viewGridBtn" title="卡片视图"><i class="fas fa-th-large"></i></button>
                            <button class="view-toggle-btn" id="viewListBtn" title="列表视图"><i class="fas fa-list"></i></button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 卡片网格 -->
            <div class="row g-3" id="examplesCardGrid"></div>

            <!-- 分页栏 -->
            <div class="pagination-bar" id="examplesPaginationWrap">
                <div class="page-info" id="pageInfo"></div>
                <ul class="pagination mb-0" id="examplesPagination"></ul>
                <div class="d-flex align-items-center gap-2">
                    <label class="text-muted small mb-0">每页</label>
                    <select class="form-select form-select-sm" id="pageSizeSelect" style="width:70px;">
                        <option value="6">6</option>
                        <option value="9">9</option>
                        <option value="12" selected>12</option>
                        <option value="24">24</option>
                    </select>
                </div>
            </div>

            <!-- JSON编辑器（隐藏） -->
            <div id="examplesEditWrap" style="display:none;" class="mt-3">
                <div class="form-text mb-2">以JSON数组格式编辑，每个示例包含 name、description、user_requirement、workflow 字段</div>
                <textarea id="examplesEditor" class="form-control" rows="20" style="font-size:13px; font-family:monospace;"></textarea>
                <div class="mt-2 d-flex gap-2">
                    <button class="btn btn-sm btn-primary" id="saveExamplesBtn">
                        <i class="fas fa-save"></i> 保存
                    </button>
                    <button class="btn btn-sm btn-secondary" id="cancelExamplesBtn">取消</button>
                </div>
            </div>
        </div>

        <!-- 完整Prompt预览模态框 -->
        <div class="modal fade" id="promptPreviewModal" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="fas fa-eye"></i> 完整Prompt预览（发送给LLM的实际内容）</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <ul class="nav nav-tabs" id="previewTabs">
                            <li class="nav-item">
                                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabSystem">System Prompt</button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabUser">User Prompt (示例)</button>
                            </li>
                        </ul>
                        <div class="tab-content mt-2">
                            <div class="tab-pane fade show active" id="tabSystem">
                                <pre id="previewSystemPrompt" class="bg-light p-3 rounded" style="white-space:pre-wrap; max-height:500px; overflow-y:auto; font-size:13px;"></pre>
                            </div>
                            <div class="tab-pane fade" id="tabUser">
                                <pre id="previewUserPrompt" class="bg-light p-3 rounded" style="white-space:pre-wrap; max-height:500px; overflow-y:auto; font-size:13px;"></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 模板详情弹窗 -->
        <div class="modal fade" id="detailModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="detailModalLabel">模板详情</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body" id="detailModalBody"></div>
                </div>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    function showAlert(type, msg) {
        const wrap = document.querySelector('main');
        const div = document.createElement('div');
        div.className = 'alert alert-' + type + ' alert-dismissible fade show mt-3';
        div.style.cssText = 'position:fixed;top:70px;right:20px;z-index:9999;min-width:300px;max-width:500px;';
        div.innerHTML = msg + '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>';
        document.body.appendChild(div);
        setTimeout(() => div.remove(), 4000);
    }

    // ===== System Prompt 结构化渲染 =====
    function renderSystemPrompt(raw) {
        var container = document.getElementById('systemPromptRendered');
        var sections = parsePromptSections(raw);
        var html = '';
        sections.forEach(function(sec, idx) {
            html += '<div class="sp-section">';
            html += '<div class="sp-section-title sp-collapse-toggle" data-idx="' + idx + '">';
            html += '<i class="fas ' + sec.icon + '"></i> ' + escHtml(sec.title);
            html += '</div>';
            html += '<div class="sp-section-body" id="spBody' + idx + '">';
            html += sec.html;
            html += '</div></div>';
        });
        container.innerHTML = html;
        // bind collapse toggles
        container.querySelectorAll('.sp-collapse-toggle').forEach(function(el) {
            el.addEventListener('click', function() {
                var body = document.getElementById('spBody' + el.dataset.idx);
                var hidden = body.style.display === 'none';
                body.style.display = hidden ? '' : 'none';
                el.classList.toggle('collapsed', !hidden);
            });
        });
    }

    function parsePromptSections(raw) {
        var sections = [];
        var lines = raw.split('\n');
        var currentTitle = '';
        var currentLines = [];
        var codeBlock = '';
        var inCode = false;   // inside ``` fenced block
        var inJson = false;   // inside bare { } block
        var jsonBlock = '';

        function flushSection() {
            if (!currentTitle && currentLines.length === 0) return;
            var title = currentTitle || '角色定义';
            var text = currentLines.join('\n').trim();
            if (!text) return;
            sections.push(buildSection(title, text));
            currentLines = [];
        }

        for (var i = 0; i < lines.length; i++) {
            var line = lines[i];

            // --- Markdown fenced code block (```json ... ```) ---
            if (!inCode && !inJson && /^\s*```/.test(line)) {
                inCode = true;
                codeBlock = '';
                continue;
            }
            if (inCode) {
                if (/^\s*```\s*$/.test(line)) {
                    inCode = false;
                    // Try to pretty-print if it's valid JSON
                    var formatted = codeBlock.trim();
                    try {
                        formatted = JSON.stringify(JSON.parse(formatted), null, 2);
                    } catch(e) {}
                    currentLines.push('__JSON__' + formatted);
                    codeBlock = '';
                } else {
                    codeBlock += line + '\n';
                }
                continue;
            }

            // --- Bare JSON block (line is exactly "{") ---
            if (!inJson && line.trim() === '{') {
                inJson = true;
                jsonBlock = line + '\n';
                continue;
            }
            if (inJson) {
                jsonBlock += line + '\n';
                if (line.trim() === '}') {
                    inJson = false;
                    var fmtJson = jsonBlock.trim();
                    try {
                        fmtJson = JSON.stringify(JSON.parse(fmtJson), null, 2);
                    } catch(e) {}
                    currentLines.push('__JSON__' + fmtJson);
                    jsonBlock = '';
                }
                continue;
            }
            // Detect section headers
            if (/^请按照以下JSON格式/.test(line.trim())) {
                flushSection();
                currentTitle = 'JSON输出格式';
                currentLines.push(line);
                continue;
            }
            if (/^对于每个任务/.test(line.trim()) || /^[-·]/.test(line.trim())) {
                if (currentTitle !== '编排规则' && /^对于每个任务/.test(line.trim())) {
                    flushSection();
                    currentTitle = '编排规则';
                }
                currentLines.push(line);
                continue;
            }
            if (/^可用服务/.test(line.trim())) {
                flushSection();
                currentTitle = '可用服务';
                currentLines.push(line);
                continue;
            }
            currentLines.push(line);
        }
        flushSection();
        return sections;
    }

    function buildSection(title, text) {
        var iconMap = {
            '角色定义': 'fa-user-tie',
            '可用服务': 'fa-cloud',
            'JSON输出格式': 'fa-code',
            '编排规则': 'fa-list-check'
        };
        var icon = iconMap[title] || 'fa-file-alt';
        var html = '';

        // Check for JSON blocks
        var parts = text.split(/(__JSON__)/);
        var segments = [];
        var temp = '';
        for (var i = 0; i < parts.length; i++) {
            if (parts[i] === '__JSON__') {
                if (temp.trim()) segments.push({type:'text', val:temp.trim()});
                temp = '';
                i++;
                if (i < parts.length) segments.push({type:'json', val:parts[i]});
            } else {
                temp += parts[i];
            }
        }
        if (temp.trim()) segments.push({type:'text', val:temp.trim()});

        segments.forEach(function(seg) {
            if (seg.type === 'json') {
                html += '<div class="sp-json-block">' + highlightJson(escHtml(seg.val)) + '</div>';
            } else {
                // Check if it's a list of rules
                var ruleLines = seg.val.split('\n').filter(function(l) { return l.trim(); });
                var isList = ruleLines.length > 1 && ruleLines.filter(function(l) {
                    return /^\s*[-·]/.test(l);
                }).length > ruleLines.length * 0.5;

                if (isList) {
                    html += '<ul class="sp-rule-list">';
                    ruleLines.forEach(function(l) {
                        var clean = l.replace(/^\s*[-·]\s*/, '').trim();
                        if (clean) {
                            clean = escHtml(clean).replace(
                                /\{\{[^}]+\}\}/g,
                                function(m) { return '<span class="sp-var-tag">' + m + '</span>'; }
                            );
                            html += '<li>' + clean + '</li>';
                        }
                    });
                    html += '</ul>';
                } else {
                    var rendered = escHtml(seg.val).replace(
                        /\{\{[^}]+\}\}/g,
                        function(m) { return '<span class="sp-var-tag">' + m + '</span>'; }
                    );
                    html += '<div class="sp-role-text">' + rendered.replace(/\n/g, '<br>') + '</div>';
                }
            }
        });

        return {title: title, icon: icon, html: html};
    }

    function highlightJson(escaped) {
        // Simple JSON syntax highlighting on already-escaped HTML
        return escaped
            .replace(/&quot;([^&]*)&quot;\s*:/g, '<span class="jk">&quot;$1&quot;</span>:')
            .replace(/:\s*&quot;([^&]*)&quot;/g, ': <span class="js">&quot;$1&quot;</span>')
            .replace(/:\s*(\d+)/g, ': <span class="jn">$1</span>')
            .replace(/\{\{[^}]+\}\}/g, function(m) { return '<span class="jp">' + m + '</span>'; });
    }

    // ===== System Prompt 编辑 =====
    document.getElementById('editSystemPromptBtn').addEventListener('click', function() {
        var raw = document.getElementById('systemPromptView').textContent.trim();
        document.getElementById('systemPromptEditor').value = raw;
        document.getElementById('systemPromptRendered').style.display = 'none';
        document.getElementById('systemPromptRawWrap').style.display = 'none';
        document.getElementById('systemPromptEditWrap').style.display = 'block';
    });

    document.getElementById('cancelSystemPromptBtn').addEventListener('click', function() {
        document.getElementById('systemPromptRendered').style.display = '';
        document.getElementById('systemPromptRawWrap').style.display = 'none';
        document.getElementById('systemPromptEditWrap').style.display = 'none';
    });

    // Toggle raw/rendered view
    document.getElementById('toggleRawBtn').addEventListener('click', function() {
        var rendered = document.getElementById('systemPromptRendered');
        var raw = document.getElementById('systemPromptRawWrap');
        var editWrap = document.getElementById('systemPromptEditWrap');
        if (editWrap.style.display === 'block') return; // don't toggle during edit
        var showingRendered = rendered.style.display !== 'none';
        rendered.style.display = showingRendered ? 'none' : '';
        raw.style.display = showingRendered ? '' : 'none';
        this.classList.toggle('active', showingRendered);
    });

    document.getElementById('saveSystemPromptBtn').addEventListener('click', async function() {
        var btn = this;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 保存中...';
        try {
            var newVal = document.getElementById('systemPromptEditor').value;
            var resp = await fetch('/api/settings/prompt', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ system_prompt: newVal })
            });
            var result = await resp.json();
            if (result.success) {
                document.getElementById('systemPromptView').textContent = newVal;
                renderSystemPrompt(newVal);
                document.getElementById('systemPromptRendered').style.display = '';
                document.getElementById('systemPromptRawWrap').style.display = 'none';
                document.getElementById('systemPromptEditWrap').style.display = 'none';
                showAlert('success', 'System Prompt 已保存');
            } else {
                showAlert('danger', '保存失败: ' + result.error);
            }
        } catch (err) {
            showAlert('danger', '请求失败: ' + err.message);
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-save"></i> 保存';
        }
    });

    // Initial render of system prompt
    (function() {
        var raw = document.getElementById('systemPromptView').textContent.trim();
        if (raw) renderSystemPrompt(raw);
    })();

    // ===== 示例工作流 - 展览卡片+搜索+分页 =====
    let allExamples = [];
    let filteredExamples = [];
    let currentPage = 1;
    let pageSize = 12;
    let viewMode = 'grid'; // 'grid' | 'list'

    // 从workflow JSON中提取服务标签
    function extractServices(workflow) {
        const services = new Set();
        try {
            const wf = typeof workflow === 'string' ? JSON.parse(workflow) : workflow;
            (wf.tasks || []).forEach(function(t) { if (t.service) services.add(t.service); });
        } catch(e) {}
        return Array.from(services);
    }

    // 从workflow JSON中提取任务数
    function countTasks(workflow) {
        try {
            const wf = typeof workflow === 'string' ? JSON.parse(workflow) : workflow;
            return (wf.tasks || []).length;
        } catch(e) { return 0; }
    }

    // 服务名到颜色映射
    function svcColor(svc) {
        const map = {vpc:'primary',eip:'info',elb:'info',ecs:'success',cce:'warning',
            rds:'danger',gaussdb:'danger',dcs:'secondary',obs:'dark',fgs:'success',
            apig:'primary',smn:'info',sfsturbo:'dark',modelarts:'warning',kafka:'secondary'};
        return map[svc] || 'secondary';
    }

    document.getElementById('editExamplesBtn').addEventListener('click', async function() {
        try {
            const resp = await fetch('/api/settings/prompt');
            const result = await resp.json();
            if (result.success) allExamples = result.data.examples || [];
        } catch (e) {}
        document.getElementById('examplesEditor').value = JSON.stringify(allExamples, null, 2);
        document.getElementById('examplesCardGrid').style.display = 'none';
        document.getElementById('examplesPaginationWrap').style.display = 'none';
        document.getElementById('searchToolbar').style.display = 'none';
        document.getElementById('examplesEditWrap').style.display = 'block';
    });

    document.getElementById('cancelExamplesBtn').addEventListener('click', function() {
        document.getElementById('examplesCardGrid').style.display = '';
        document.getElementById('examplesPaginationWrap').style.display = '';
        document.getElementById('searchToolbar').style.display = '';
        document.getElementById('examplesEditWrap').style.display = 'none';
    });

    document.getElementById('saveExamplesBtn').addEventListener('click', async function() {
        const btn = this;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 保存中...';
        try {
            const examples = JSON.parse(document.getElementById('examplesEditor').value);
            const resp = await fetch('/api/settings/prompt', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ examples: examples })
            });
            const result = await resp.json();
            if (result.success) {
                showAlert('success', '示例工作流已保存');
                allExamples = examples;
                buildServiceFilter();
                applyFilter();
                document.getElementById('examplesCardGrid').style.display = '';
                document.getElementById('examplesPaginationWrap').style.display = '';
                document.getElementById('searchToolbar').style.display = '';
                document.getElementById('examplesEditWrap').style.display = 'none';
            } else {
                showAlert('danger', '保存失败: ' + result.error);
            }
        } catch (err) {
            showAlert('danger', 'JSON格式错误: ' + err.message);
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-save"></i> 保存';
        }
    });

    // 渲染卡片网格
    function renderCards() {
        const grid = document.getElementById('examplesCardGrid');
        const start = (currentPage - 1) * pageSize;
        const pageItems = filteredExamples.slice(start, start + pageSize);

        // 设置视图模式 class
        grid.classList.toggle('view-list', viewMode === 'list');

        if (pageItems.length === 0) {
            grid.innerHTML = '<div class="col-12 text-center text-muted py-5">' +
                '<i class="fas fa-inbox fa-3x mb-3 d-block" style="opacity:.3;"></i>' +
                '没有匹配的模板</div>';
            renderPagination();
            return;
        }

        grid.innerHTML = pageItems.map(function(ex, i) {
            const svcs = extractServices(ex.workflow);
            const taskCount = countTasks(ex.workflow);
            const idx = start + i;
            const svcBadges = svcs.map(function(s) {
                return '<span class="badge svc-badge bg-' + svcColor(s) + ' me-1 mb-1">' + s + '</span>';
            }).join('');
            var reqPreview = escHtml((ex.user_requirement || '').substring(0, 120));
            if ((ex.user_requirement || '').length > 120) reqPreview += '...';

            var colClass = viewMode === 'list' ? 'col-12 col-card' : 'col-md-6 col-lg-4 col-card';

            return '<div class="' + colClass + '" style="animation-delay:' + (i * 0.04) + 's;">' +
                '<div class="card h-100 shadow-sm example-card card-animate">' +
                '<div class="card-header-strip"></div>' +
                '<div class="card-body d-flex flex-column">' +
                '<div class="d-flex align-items-start justify-content-between mb-2">' +
                '<h6 class="card-title mb-0">' +
                '<i class="fas fa-file-code text-primary me-2"></i>' +
                escHtml(ex.name || '') + '</h6>' +
                '<span class="badge bg-light text-dark task-count ms-2 flex-shrink-0">' +
                '<i class="fas fa-tasks me-1"></i>' + taskCount + '</span></div>' +
                '<p class="card-desc mb-2">' + escHtml(ex.description || '') + '</p>' +
                '<div class="mb-2">' + svcBadges + '</div>' +
                (reqPreview ? '<div class="user-req-preview"><i class="fas fa-quote-left me-1" style="opacity:.4;"></i>' + reqPreview + '</div>' : '') +
                '</div>' +
                '<div class="card-footer-bar">' +
                '<span class="task-count"><i class="fas fa-layer-group me-1"></i>' + svcs.length + ' 个服务 / ' + taskCount + ' 个任务</span>' +
                '<button class="btn btn-sm btn-outline-primary view-detail-btn" data-idx="' + idx + '">' +
                '<i class="fas fa-eye me-1"></i>详情</button>' +
                '</div></div></div>';
        }).join('');

        renderPagination();
    }

    function escHtml(s) {
        return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    // 分页渲染
    function renderPagination() {
        const total = filteredExamples.length;
        const totalPages = Math.ceil(total / pageSize);
        const nav = document.getElementById('examplesPagination');
        const stats = document.getElementById('exampleStats');
        const pageInfo = document.getElementById('pageInfo');

        stats.textContent = '共 ' + allExamples.length + ' 个模板' +
            (filteredExamples.length < allExamples.length ? '，匹配 ' + filteredExamples.length + ' 个' : '');

        var start = (currentPage - 1) * pageSize + 1;
        var end = Math.min(currentPage * pageSize, total);
        pageInfo.textContent = total > 0 ? ('显示 ' + start + '-' + end + ' / 共 ' + total + ' 个') : '';

        if (totalPages <= 1) { nav.innerHTML = ''; return; }

        var html = '';
        html += '<li class="page-item ' + (currentPage===1?'disabled':'') + '">' +
            '<a class="page-link" href="#" data-page="' + (currentPage-1) + '">&laquo;</a></li>';

        // 智能分页：显示首页、末页、当前页附近
        var pages = [];
        pages.push(1);
        for (var p = currentPage - 2; p <= currentPage + 2; p++) {
            if (p > 1 && p < totalPages) pages.push(p);
        }
        pages.push(totalPages);

        var prev = 0;
        pages.forEach(function(p) {
            if (p - prev > 1) {
                html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
            }
            html += '<li class="page-item ' + (p===currentPage?'active':'') + '">' +
                '<a class="page-link" href="#" data-page="' + p + '">' + p + '</a></li>';
            prev = p;
        });

        html += '<li class="page-item ' + (currentPage===totalPages?'disabled':'') + '">' +
            '<a class="page-link" href="#" data-page="' + (currentPage+1) + '">&raquo;</a></li>';
        nav.innerHTML = html;
    }

    // 构建服务筛选下拉
    function buildServiceFilter() {
        var allSvcs = new Set();
        allExamples.forEach(function(ex) {
            extractServices(ex.workflow).forEach(function(s) { allSvcs.add(s); });
        });
        var sel = document.getElementById('serviceFilter');
        var current = sel.value;
        sel.innerHTML = '<option value="">全部服务</option>';
        Array.from(allSvcs).sort().forEach(function(s) {
            sel.innerHTML += '<option value="' + s + '">' + s + '</option>';
        });
        sel.value = current;
    }

    // 搜索过滤（支持关键词 + 服务筛选）
    function applyFilter() {
        const q = document.getElementById('exampleSearch').value.trim().toLowerCase();
        const svcFilter = document.getElementById('serviceFilter').value;

        // 显示/隐藏清除按钮
        var clearBtn = document.getElementById('clearSearchBtn');
        clearBtn.classList.toggle('d-none', !q);

        filteredExamples = allExamples.filter(function(ex) {
            // 关键词匹配
            if (q) {
                var text = (ex.name||'') + ' ' + (ex.description||'') + ' ' + (ex.user_requirement||'');
                if (text.toLowerCase().indexOf(q) < 0) return false;
            }
            // 服务筛选
            if (svcFilter) {
                var svcs = extractServices(ex.workflow);
                if (svcs.indexOf(svcFilter) < 0) return false;
            }
            return true;
        });
        currentPage = 1;
        renderCards();
    }

    // 显示详情弹窗
    function showDetail(idx) {
        const ex = filteredExamples[idx];
        if (!ex) return;
        const svcs = extractServices(ex.workflow);
        const taskCount = countTasks(ex.workflow);
        const svcBadges = svcs.map(function(s) {
            return '<span class="badge bg-' + svcColor(s) + ' me-1 mb-1">' + s + '</span>';
        }).join('');

        const html =
            '<div class="mb-3"><h5>' + escHtml(ex.name || '') + '</h5>' +
            '<p class="text-muted">' + escHtml(ex.description || '') + '</p></div>' +
            '<div class="mb-3"><strong>涉及服务：</strong><div class="mt-1">' + svcBadges + '</div></div>' +
            '<div class="mb-3"><strong>任务数：</strong>' + taskCount + '</div>' +
            '<div class="mb-3"><strong>用户需求：</strong>' +
            '<div class="bg-light p-2 rounded mt-1 small">' + escHtml(ex.user_requirement || '') + '</div></div>' +
            '<div><strong>工作流 JSON：</strong>' +
            '<pre class="bg-light p-2 rounded mt-1" style="max-height:400px;overflow-y:auto;font-size:12px;">' +
            escHtml(ex.workflow || '') + '</pre></div>';

        document.getElementById('detailModalBody').innerHTML = html;
        document.getElementById('detailModalLabel').textContent = ex.name || '模板详情';
        new bootstrap.Modal(document.getElementById('detailModal')).show();
    }

    // ===== 完整Prompt预览 =====
    document.getElementById('previewPromptBtn').addEventListener('click', async function() {
        const btn = this;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 加载中...';
        try {
            const resp = await fetch('/api/settings/prompt/preview');
            const result = await resp.json();
            if (result.success) {
                document.getElementById('previewSystemPrompt').textContent = result.data.system_prompt;
                document.getElementById('previewUserPrompt').textContent = result.data.user_prompt;
                new bootstrap.Modal(document.getElementById('promptPreviewModal')).show();
            } else {
                showAlert('danger', '预览失败: ' + result.error);
            }
        } catch (err) {
            showAlert('danger', '请求失败: ' + err.message);
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-eye"></i> 预览完整Prompt';
        }
    });

    // ===== 事件绑定 =====
    // 搜索框
    let searchTimer = null;
    document.getElementById('exampleSearch').addEventListener('input', function() {
        clearTimeout(searchTimer);
        searchTimer = setTimeout(applyFilter, 200);
    });

    // 清除搜索
    document.getElementById('clearSearchBtn').addEventListener('click', function() {
        document.getElementById('exampleSearch').value = '';
        applyFilter();
    });

    // 服务筛选
    document.getElementById('serviceFilter').addEventListener('change', applyFilter);

    // 视图切换
    document.getElementById('viewGridBtn').addEventListener('click', function() {
        viewMode = 'grid';
        this.classList.add('active');
        document.getElementById('viewListBtn').classList.remove('active');
        renderCards();
    });
    document.getElementById('viewListBtn').addEventListener('click', function() {
        viewMode = 'list';
        this.classList.add('active');
        document.getElementById('viewGridBtn').classList.remove('active');
        renderCards();
    });

    // 每页数量
    document.getElementById('pageSizeSelect').addEventListener('change', function() {
        pageSize = parseInt(this.value);
        currentPage = 1;
        renderCards();
    });

    // 分页点击（事件委托）
    document.getElementById('examplesPagination').addEventListener('click', function(e) {
        e.preventDefault();
        const link = e.target.closest('[data-page]');
        if (!link) return;
        const p = parseInt(link.dataset.page);
        const totalPages = Math.ceil(filteredExamples.length / pageSize);
        if (p < 1 || p > totalPages) return;
        currentPage = p;
        renderCards();
        document.getElementById('searchToolbar').scrollIntoView({behavior:'smooth', block:'start'});
    });

    // 详情按钮点击（事件委托）
    document.getElementById('examplesCardGrid').addEventListener('click', function(e) {
        const btn = e.target.closest('.view-detail-btn');
        if (!btn) return;
        showDetail(parseInt(btn.dataset.idx));
    });

    // ===== 初始化加载 =====
    (async function() {
        try {
            const resp = await fetch('/api/settings/prompt');
            const result = await resp.json();
            if (result.success) {
                allExamples = result.data.examples || [];
            }
        } catch(e) {
            allExamples = [];
        }
        filteredExamples = allExamples.slice();
        buildServiceFilter();
        renderCards();
    })();
    </script>
</body>
</html>
